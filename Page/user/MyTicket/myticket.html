<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RAILLY - My ticket</title>
  <link rel="stylesheet" href="./MyTicket.css" />
  <link rel="stylesheet" href="../../index.css" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,100..900&display=swap');
  </style>
  <script src="../../assets/js/user-session.js" defer></script>
  <script src="../../assets/js/layout-loader.js" defer></script>
</head>
<body>
  <div
    data-include="../shared/header.html"
    data-nav-active="myticket"
  ></div>

  <main>
    <div class="topper"><h2>MY TICKET</h2></div>
    <div><h3>Show Your Ticket to the Train Staff</h3></div>
    <p>
      Please present your E-ticket by showing the E-ticket below to the train staff when requested.
      Simply scan the barcode at the station or on the train for a smooth and hassle-free boarding experience.
    </p>

    <div id="ticket-results" class="ticket-container">
      <p class="no-tickets">Fetching your tickets...</p>
    </div>
  </main>

  <div data-include="../shared/footer.html"></div>

  <script>
    function initialiseMyTicketPage() {
      const session = window.userSession;
      const context = session ? session.getUserContext() : { username: null, id: null };

      if (!context.username || !context.id) {
        alert("Please log in to view your tickets.");
        window.location.href = "../Login/Login.html";
        return;
      }

      if (session) {
        session.applyUserContextToLinks('.site-header .main-nav a, .site-header .brand, .site-header .user-profile-link');
      }

      // Fetch ticket data
      fetch(`../../Backend/getUserTickets.php?username=${context.username}&id=${context.id}`)
        .then(response => response.json())
        .then(data => {
          const ticketContainer = document.getElementById("ticket-results");

          if (data.status === "error") {
            ticketContainer.innerHTML = `<p class="no-tickets">${data.message}</p>`;
            return;
          }

          if (data.tickets.length === 0) {
            ticketContainer.innerHTML = `<p class="no-tickets">You have no tickets booked yet.</p>`;
            return;
          }

          ticketContainer.innerHTML = ""; // Clear loading text

          data.tickets.forEach(ticket => {
            const ticketCard = document.createElement("div");
            ticketCard.classList.add("ticket");

            ticketCard.innerHTML = `
              <div class="ticket-details">
                <div class="train-time">
                  <span>${ticket.departure}</span> 
                  <span>${ticket.origin}</span> 
                  <span class="arrow">â†’</span> 
                  <span>${ticket.arrival}</span> 
                  <span>${ticket.destination}</span>
                </div>
                <div class="additional-info">
                  <p><strong>Date:</strong> ${ticket.datee}</p>
                  <p><strong>Train Route:</strong> #${ticket.route_id}</p>
                  <p><strong>Price:</strong> ${ticket.price} THB / person</p>
                </div>
                <div class="barcode">
                  <img src="https://barcode.tec-it.com/barcode.ashx?data=${ticket.route_id}" alt="Barcode">
                </div>
              </div>
            `;
            ticketContainer.appendChild(ticketCard);
          });
        })
        .catch(error => {
          console.error("Error fetching tickets:", error);
          document.getElementById("ticket-results").innerHTML = `<p class="no-tickets">Error fetching tickets. Please try again later.</p>`;
        });
    }

    if (window.__layoutReady) {
      initialiseMyTicketPage();
    } else {
      document.addEventListener('layout:ready', initialiseMyTicketPage, { once: true });
    }
  </script>
</body>
</html>